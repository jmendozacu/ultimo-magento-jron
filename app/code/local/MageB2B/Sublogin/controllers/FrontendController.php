<?php

class
MageB2B_Sublogin_FrontendController
extends
Mage_Core_Controller_Front_Action
{
public
function
preDispatch()
{
parent::preDispatch();
if
(!Mage::getSingleton('customer/session')->authenticate($this))
{
$this->setFlag('',
'no-dispatch',
true);
}
}

public
function
indexAction()
{
$this->loadLayout();
$this->getLayout()->getBlock('head')->setTitle($this->__('My Sublogins'));
if
($_d1b5a9e6d88844d06736cc808299e4fce5599202
=
$this->getLayout()->getBlock('customer.account.link.back'))
{
$_d1b5a9e6d88844d06736cc808299e4fce5599202->setRefererUrl($this->_getRefererUrl());
}
$this->renderLayout();
}

public
function
createAction()
{
$this->_forward('edit');
}

public
function
editAction()
{
$_7661e073459e96b1adbc480bebcb023560a54a58
=
Mage::getStoreConfig('sublogin/general/expire_interval');
$_ce376578098cf70af7021fca72fe4e15a4a98365
=
$this->getRequest()->getParam('id');
$_384d479d3c396afbfb7e832d2d450608e3145d55
=
Mage::getModel('sublogin/sublogin')->load($_ce376578098cf70af7021fca72fe4e15a4a98365);
$_b803c43bc8b3ef64b7d19b78f670cdbd11dacf8c
=
Mage::getSingleton('customer/session')->getCustomer();
if
($this->hasAccess($_384d479d3c396afbfb7e832d2d450608e3145d55)
&&
($_384d479d3c396afbfb7e832d2d450608e3145d55->getId()
||
$_ce376578098cf70af7021fca72fe4e15a4a98365
==
0))
{
if
($_384d479d3c396afbfb7e832d2d450608e3145d55->getId()
&&
$_384d479d3c396afbfb7e832d2d450608e3145d55->getEntityId()
!=
$_b803c43bc8b3ef64b7d19b78f670cdbd11dacf8c->getId())
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('You are not allowed to edit this sublogin'));
$this->_redirect('*/*/');
return;
}
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('expire_date',
$this->unFormatDate($_384d479d3c396afbfb7e832d2d450608e3145d55->getData('expire_date')));
if
($this->getRequest()->isPost())
{
$this->setMissingParams();
$_6fb02c14a9aa8279c0be3446f87b5153ed38c016
=
false;
$_02000d93f53443c66f188e6620797faaaeba5739
=
false;

$_791b80c93437c3a51c059f29b3d495ff07ca01e2
=
array('firstname',
'lastname',
'email',
'active');
$_791b80c93437c3a51c059f29b3d495ff07ca01e2
=
array_merge($_791b80c93437c3a51c059f29b3d495ff07ca01e2,
array_keys(Mage::getModel('sublogin/source_formfields')->getDefaultValues()))
;
$_2a145552e00905331cd502938610b699e18379e0
=
array('firstname',
'lastname',
'email');
$_da9741d865f8de50c427250ecfa2890ae98ae8d0
=
false;
if
($_ce376578098cf70af7021fca72fe4e15a4a98365
==
0)
{
$_2a145552e00905331cd502938610b699e18379e0[]
=
'password';
$_02000d93f53443c66f188e6620797faaaeba5739
=
true;
}
foreach
($_2a145552e00905331cd502938610b699e18379e0
as
$_5daa1085ee90198c9df8565a4a980ca7a8d3f105)
{
if
(!$this->getRequest()->getParam($_5daa1085ee90198c9df8565a4a980ca7a8d3f105))
{
$_da9741d865f8de50c427250ecfa2890ae98ae8d0
=
true;
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('%s is required',
$this->__($_5daa1085ee90198c9df8565a4a980ca7a8d3f105)));
}
}

$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607
=
$this->getRequest()->getParam('email');
if
($_384d479d3c396afbfb7e832d2d450608e3145d55->getData('email')
!=
$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607)
{
if
(!Mage::helper('sublogin')->validateUniqueEmail($_ff0a3525eb1a63ce44e7951a0b522829a4d2f607,
$_b803c43bc8b3ef64b7d19b78f670cdbd11dacf8c->getWebsiteId()))
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('Email "%s" already exists',
$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607));
$_da9741d865f8de50c427250ecfa2890ae98ae8d0
=
true;
}
}
if
($_da9741d865f8de50c427250ecfa2890ae98ae8d0)
{
$this->_redirect('sublogin/frontend/edit',
array('id'
=>
$_384d479d3c396afbfb7e832d2d450608e3145d55->getId()));
return;
}

foreach
($_791b80c93437c3a51c059f29b3d495ff07ca01e2
as
$_5daa1085ee90198c9df8565a4a980ca7a8d3f105)
{
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData($_5daa1085ee90198c9df8565a4a980ca7a8d3f105,$this->getRequest()->getParam($_5daa1085ee90198c9df8565a4a980ca7a8d3f105));
}
if
($this->getRequest()->getParam('address_ids'))
{
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('address_ids',
implode(',',$this->getRequest()->getParam('address_ids')));
}
else
{
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('address_ids',
'');
}
if
($this->getRequest()->getParam('acl'))
{
$_b753179da5bff34c40eb3baf649cf83e44b9c9bc
=
$this->getRequest()->getParam('acl');
if
(is_array($_b753179da5bff34c40eb3baf649cf83e44b9c9bc))
{
$_b753179da5bff34c40eb3baf649cf83e44b9c9bc
=
implode(',',
$_b753179da5bff34c40eb3baf649cf83e44b9c9bc);
}
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('acl',
$_b753179da5bff34c40eb3baf649cf83e44b9c9bc);
}
else
{
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('acl',
'');
}
if
($this->getRequest()->getParam('password'))
{
if
(!
($this->getRequest()->getParam('password')
==
'******'
||
$this->getRequest()->getParam('password')
==
'')
)
{
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('password',
Mage::helper('core')->getHash($this->getRequest()->getParam('password'),
2));
$_6fb02c14a9aa8279c0be3446f87b5153ed38c016
=
true;
}
}
if
($this->getRequest()->getParam('expire_date'))
{
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b
=
$this->formatDate($this->getRequest()->getParam('expire_date'));
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('expire_date',
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b);
}
else
{

if
($_7661e073459e96b1adbc480bebcb023560a54a58>0)
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('expire_date',
date('Y-m-d',
time()+60*60*24*$_7661e073459e96b1adbc480bebcb023560a54a58));
else
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('expire_date',
new
Zend_Db_Expr('0000-00-00'));
}
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('entity_id',
Mage::getSingleton('customer/session')->getData('id'));
$_384d479d3c396afbfb7e832d2d450608e3145d55->save();
Mage::getSingleton('core/session')->addSuccess(Mage::helper('sublogin')->__('Successfully saved sublogin %s',
$_384d479d3c396afbfb7e832d2d450608e3145d55->getEmail()));

if
($_6fb02c14a9aa8279c0be3446f87b5153ed38c016
||
$_02000d93f53443c66f188e6620797faaaeba5739)
{

$_384d479d3c396afbfb7e832d2d450608e3145d55->setPassword($this->getRequest()->getParam('password'));

$_384d479d3c396afbfb7e832d2d450608e3145d55->setStoreId(Mage::app()->getStore()->getId());
if
($_02000d93f53443c66f188e6620797faaaeba5739)
{
Mage::helper('sublogin/email')->sendNewSubloginEmail($_384d479d3c396afbfb7e832d2d450608e3145d55);
}
else
if
($_6fb02c14a9aa8279c0be3446f87b5153ed38c016)
{
Mage::helper('sublogin/email')->sendNewPasswordEmail($_384d479d3c396afbfb7e832d2d450608e3145d55);
}
}
$this->_redirect('sublogin/frontend/edit',
array('id'=>$_384d479d3c396afbfb7e832d2d450608e3145d55->getId()));
return;
}
Mage::register('subloginModel',
$_384d479d3c396afbfb7e832d2d450608e3145d55);
$this->loadLayout();
if
(($_384d479d3c396afbfb7e832d2d450608e3145d55->getData('id'))
==
0)
{
$this->getLayout()->getBlock('head')->setTitle($this->__('Create new sublogin'));
}
else
{
$this->getLayout()->getBlock('head')->setTitle($this->__('Edit Sublogin'));
}
$this->renderLayout();
}
else
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('Item does not exist'));
$this->_redirect('*/*/');
}
}

public
function
deleteAction()
{
$_ce376578098cf70af7021fca72fe4e15a4a98365
=
$this->getRequest()->getParam('id');
$_384d479d3c396afbfb7e832d2d450608e3145d55
=
Mage::getModel('sublogin/sublogin')->load($_ce376578098cf70af7021fca72fe4e15a4a98365);
if
(!$_384d479d3c396afbfb7e832d2d450608e3145d55->getId()
||
!$this->hasAccess($_384d479d3c396afbfb7e832d2d450608e3145d55))
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('Item does not exist'));
$this->_redirect('*/*/');
}
else
{
if
($_384d479d3c396afbfb7e832d2d450608e3145d55->getEntityId()
!=
Mage::getSingleton('customer/session')->getCustomer()->getId())
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('You are not allowed to delete this sublogin'));
$this->_redirect('*/*/');
return;
}
$_384d479d3c396afbfb7e832d2d450608e3145d55->delete();
Mage::getSingleton('core/session')->addSuccess(Mage::helper('sublogin')->__('Deleted sublogin %s',
$_384d479d3c396afbfb7e832d2d450608e3145d55->getEmail()));
$this->_redirect('sublogin/frontend/index');
}
}

protected
function
hasAccess($_4e45fa4f3249d9c3cc1314ed89922593008cf117)
{

if
(!Mage::getSingleton('customer/session')->isLoggedIn())
{
return
false;
}

if
(!Mage::helper('sublogin')->getCurrentSublogin())
{
return
true;
}
if
($_4e45fa4f3249d9c3cc1314ed89922593008cf117->getCreateSublogins()
||
Mage::helper('sublogin')->getCurrentSublogin()->getCreateSublogins())
{
return
true;
}

if
($_4e45fa4f3249d9c3cc1314ed89922593008cf117->getId()
&&
$_4e45fa4f3249d9c3cc1314ed89922593008cf117->getEntityId()
!=
Mage::getSingleton('customer/session')->getData('id'))
{
return
false;
}

return
true;
}

public
function
unFormatDate($_f0c57a04a51d1d900c8d28a111ab8f340a17465b)
{
if
(!$_f0c57a04a51d1d900c8d28a111ab8f340a17465b
||
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b
==
1970
||
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b
==
0)
{
return
null;
}
return
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b;
}

public
function
formatDate($_f0c57a04a51d1d900c8d28a111ab8f340a17465b)
{
if
(empty($_f0c57a04a51d1d900c8d28a111ab8f340a17465b))
{
return
0;
}

if
(preg_match('/^[0-9]+$/',
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b))
{
if
($_f0c57a04a51d1d900c8d28a111ab8f340a17465b<=0)
return
0;
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b
=
new
Zend_Date((int)$_f0c57a04a51d1d900c8d28a111ab8f340a17465b);
}

else
if
(preg_match('#^\d{4}-\d{2}-\d{2}( \d{2}:\d{2}:\d{2})?$#',
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b))
{
if
($_f0c57a04a51d1d900c8d28a111ab8f340a17465b
<=
0)
{
return
0;
}
$_bbb3c91a8584760004706197a44eb6790aba37a9
=
new
Zend_Date();
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b
=
$_bbb3c91a8584760004706197a44eb6790aba37a9->setIso($_f0c57a04a51d1d900c8d28a111ab8f340a17465b);
}

else
{
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b
=
Mage::app()->getLocale()->date($_f0c57a04a51d1d900c8d28a111ab8f340a17465b,
Mage::app()->getLocale()->getDateFormat(Mage_Core_Model_Locale::FORMAT_TYPE_SHORT),
null,
false
);
}

return
$_f0c57a04a51d1d900c8d28a111ab8f340a17465b->toString(Varien_Date::DATE_INTERNAL_FORMAT);
}

public
function
approveorderAction()
{
$_1fca9ed82493ef87f408fb2a0e244e2ffca359d2
=
$this->getRequest()->getParam('order_id');
if
(!$_1fca9ed82493ef87f408fb2a0e244e2ffca359d2)
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('OrderID not found.'));
$this->_redirectReferer();
return;
}
try
{
$_bd0c62bfdc3abe2c29909f093a67c9c0d7f319a4
=
Mage::getModel('sales/order')->load($_1fca9ed82493ef87f408fb2a0e244e2ffca359d2);
$_bd0c62bfdc3abe2c29909f093a67c9c0d7f319a4->setState('approved')
->setStatus('approved')
->save()
;
$_bd0c62bfdc3abe2c29909f093a67c9c0d7f319a4->sendNewOrderEmail();
}
catch
(Exception
$_68dc3926fdadefc4ea3e5e09bf1dd6f6e1785aa5)
{
Mage::logException($_68dc3926fdadefc4ea3e5e09bf1dd6f6e1785aa5);
}
Mage::getSingleton('core/session')->addSuccess(Mage::helper('sublogin')->__('Order is approved.'));
$this->_redirectReferer();
}

public
function
declineorderAction()
{
$_1fca9ed82493ef87f408fb2a0e244e2ffca359d2
=
$this->getRequest()->getParam('order_id');
if
(!$_1fca9ed82493ef87f408fb2a0e244e2ffca359d2)
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('OrderID not found.'));
$this->_redirectReferer();
return;
}
try
{
$_bd0c62bfdc3abe2c29909f093a67c9c0d7f319a4
=
Mage::getModel('sales/order')->load($_1fca9ed82493ef87f408fb2a0e244e2ffca359d2);
$_bd0c62bfdc3abe2c29909f093a67c9c0d7f319a4
->setState('not_approved')
->setStatus('not_approved')
->save()
;
$_86062e25478b46d5c43aa3c9fd776ed449827851
=
$_bd0c62bfdc3abe2c29909f093a67c9c0d7f319a4->getSubloginId();
if
($_86062e25478b46d5c43aa3c9fd776ed449827851)
{
$_17fe0f58f521a1d8d613a93097a5a22f2074c04f
=
Mage::getModel('sublogin/sublogin')->load($_86062e25478b46d5c43aa3c9fd776ed449827851);
$_17fe0f58f521a1d8d613a93097a5a22f2074c04f->setData('order_id',
$_bd0c62bfdc3abe2c29909f093a67c9c0d7f319a4->getId());
$_17fe0f58f521a1d8d613a93097a5a22f2074c04f->setData('order_increment_id',
$_bd0c62bfdc3abe2c29909f093a67c9c0d7f319a4->getIncrementId());
Mage::helper('sublogin/email')->sendOrderDeclinedEmailAlert($_17fe0f58f521a1d8d613a93097a5a22f2074c04f);
}
}
catch
(Exception
$_68dc3926fdadefc4ea3e5e09bf1dd6f6e1785aa5)
{
Mage::logException($_68dc3926fdadefc4ea3e5e09bf1dd6f6e1785aa5);
}
Mage::getSingleton('core/session')->addSuccess(Mage::helper('sublogin')->__('Order is declined.'));
$this->_redirectReferer();
}

public
function
deleteorderAction()
{
if
(!Mage::helper('sublogin')->canDeleteNotApprovedOrder())
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('Delete operation not allowed.'));
$this->_redirectReferer();
return;
}
$_1fca9ed82493ef87f408fb2a0e244e2ffca359d2
=
$this->getRequest()->getParam('order_id');
if
(!$_1fca9ed82493ef87f408fb2a0e244e2ffca359d2)
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('OrderID not found.'));
$this->_redirectReferer();
return;
}
try
{
$_bd0c62bfdc3abe2c29909f093a67c9c0d7f319a4
=
Mage::getModel('sales/order')->load($_1fca9ed82493ef87f408fb2a0e244e2ffca359d2);
$_86062e25478b46d5c43aa3c9fd776ed449827851
=
$_bd0c62bfdc3abe2c29909f093a67c9c0d7f319a4->getSubloginId();
if
($_86062e25478b46d5c43aa3c9fd776ed449827851)
{
$_17fe0f58f521a1d8d613a93097a5a22f2074c04f
=
Mage::getModel('sublogin/sublogin')->load($_86062e25478b46d5c43aa3c9fd776ed449827851);
$_cf8b755008929493fc83306328aa582aeb548e78
=
$_17fe0f58f521a1d8d613a93097a5a22f2074c04f->getCustomer();
$_06d9e6a5329c56bae34f76a238daf296b7b048f5
=
Mage::getSingleton('customer/session')->getCustomer();
if
($_06d9e6a5329c56bae34f76a238daf296b7b048f5->getId()
==
$_cf8b755008929493fc83306328aa582aeb548e78->getId())
{
Mage::register('isSecureArea',
true);
$_bd0c62bfdc3abe2c29909f093a67c9c0d7f319a4->delete();
Mage::unregister('isSecureArea');
Mage::getSingleton('core/session')->addSuccess(Mage::helper('sublogin')->__('Order is deleted.'));
}
else
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('You can not delete this order.'));
}
}
else
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('You can not delete this order.'));
}
}
catch
(Exception
$_68dc3926fdadefc4ea3e5e09bf1dd6f6e1785aa5)
{
Mage::logException($_68dc3926fdadefc4ea3e5e09bf1dd6f6e1785aa5);
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('Order can not be deleted.'));
}
$this->_redirectReferer();
}
protected
function
setMissingParams()
{
$_3c464bebc1012e6fd8265f7c6ee6ea7e5be9a6b1
=
Mage::getModel('sublogin/source_formfields')->getDefaultValues();
foreach
($_3c464bebc1012e6fd8265f7c6ee6ea7e5be9a6b1
as
$_3f8de01169eabbb582c7c5ffb762d5f7d1f1bf07
=>
$_f0c614d70c91a56750ab0372fc6e1ac48138cd31)
{
if
(!$this->getRequest()->getParam($_3f8de01169eabbb582c7c5ffb762d5f7d1f1bf07))
{
$this->getRequest()->setParam($_3f8de01169eabbb582c7c5ffb762d5f7d1f1bf07,
$_f0c614d70c91a56750ab0372fc6e1ac48138cd31);
}
}
}

public
function
subloginLoginAction()
{
if
(!Mage::getSingleton('customer/session')->isLoggedIn())
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('You are not logged in.'));
$this->_redirect('*/*/*');
return;
}
if
(Mage::helper('sublogin')->getCurrentSublogin()
&&
!Mage::getSingleton('customer/session')->getLoggedinFromMainLogin())
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('You are not allowed to access this page.'));
$this->_redirect('/');
return;
}
$_86062e25478b46d5c43aa3c9fd776ed449827851
=
$this->getRequest()->getParam('id');
$_4e45fa4f3249d9c3cc1314ed89922593008cf117
=
Mage::getModel('sublogin/sublogin')->load($_86062e25478b46d5c43aa3c9fd776ed449827851);
if
($_4e45fa4f3249d9c3cc1314ed89922593008cf117->getId())
{
Mage::getSingleton('customer/session')->setLoggedinFromMainLogin(true);
Mage::getSingleton('customer/session')->setSubloginEmail($_4e45fa4f3249d9c3cc1314ed89922593008cf117->getEmail());
$_b803c43bc8b3ef64b7d19b78f670cdbd11dacf8c
=
Mage::getSingleton('customer/session')->getCustomer();
Mage::getModel('customer/resource_customer')->loadByEmail($_b803c43bc8b3ef64b7d19b78f670cdbd11dacf8c,
$_4e45fa4f3249d9c3cc1314ed89922593008cf117->getEmail());
Mage::getSingleton('core/session')->addSuccess(Mage::helper('sublogin')->__('You can now see the account of %s.',
$_4e45fa4f3249d9c3cc1314ed89922593008cf117->getFirstname()
.
' '
.
$_4e45fa4f3249d9c3cc1314ed89922593008cf117->getLastname()));
$this->_redirect('*/*/');
return;
}
}

public
function
subloginLogoutAction()
{
if
(!Mage::getSingleton('customer/session')->isLoggedIn())
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('You are not logged in.'));
$this->_redirect('*/*/*');
return;
}
if
(Mage::helper('sublogin')->getCurrentSublogin()
&&
!Mage::getSingleton('customer/session')->getLoggedinFromMainLogin())
{
Mage::getSingleton('core/session')->addError(Mage::helper('sublogin')->__('You are not allowed to access this page.'));
$this->_redirect('/');
return;
}
$_86062e25478b46d5c43aa3c9fd776ed449827851
=
$this->getRequest()->getParam('id');
$_4e45fa4f3249d9c3cc1314ed89922593008cf117
=
Mage::getModel('sublogin/sublogin')->load($_86062e25478b46d5c43aa3c9fd776ed449827851);
if
($_4e45fa4f3249d9c3cc1314ed89922593008cf117->getId())
{
Mage::getSingleton('customer/session')->setLoggedinFromMainLogin(false);
Mage::getSingleton('customer/session')->setSubloginEmail(false);
$_b803c43bc8b3ef64b7d19b78f670cdbd11dacf8c
=
Mage::getModel('customer/customer')->load($_4e45fa4f3249d9c3cc1314ed89922593008cf117->getEntityId());
Mage::getModel('customer/resource_customer')->loadByEmail($_b803c43bc8b3ef64b7d19b78f670cdbd11dacf8c,
$_b803c43bc8b3ef64b7d19b78f670cdbd11dacf8c->getEmail());
Mage::getSingleton('core/session')->addSuccess(Mage::helper('sublogin')->__('You just logged out from the account of %s.',
$_4e45fa4f3249d9c3cc1314ed89922593008cf117->getFirstname()
.
' '
.
$_4e45fa4f3249d9c3cc1314ed89922593008cf117->getLastname()));
$this->_redirect('*/*/');
return;
}
}
}
