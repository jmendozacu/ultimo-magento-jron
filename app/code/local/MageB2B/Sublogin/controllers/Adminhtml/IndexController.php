<?php

class
MageB2B_Sublogin_Adminhtml_IndexController
extends
Mage_Adminhtml_Controller_Action
{
protected
function
_initAction()
{
$this->loadLayout()
->_setActiveMenu('customer/sublogin')
->_addBreadcrumb(Mage::helper('adminhtml')->__('Items Manager'),
Mage::helper('adminhtml')->__('Sublogin Manager'));
return
$this;
}
public
function
indexAction()
{
$this->_initAction();
$this->_addContent($this->getLayout()->createBlock('sublogin/admin_sublogin_index'));
$this->renderLayout();
}

public
function
project238Action()
{
$_c01e0f340e72e992c45b537190fff109ade927d9
=
Mage::getModel('eav/entity_setup','core_setup');
$_c01e0f340e72e992c45b537190fff109ade927d9->startSetup();
$_c01e0f340e72e992c45b537190fff109ade927d9->getConnection()->addColumn($_c01e0f340e72e992c45b537190fff109ade927d9->getTable('customer_sublogin'),
'kcp',
'VARCHAR(255)');
$_c01e0f340e72e992c45b537190fff109ade927d9->getConnection()->addColumn($_c01e0f340e72e992c45b537190fff109ade927d9->getTable('customer_sublogin'),
'klt',
'VARCHAR(255)');
$_c01e0f340e72e992c45b537190fff109ade927d9->getConnection()->addColumn($_c01e0f340e72e992c45b537190fff109ade927d9->getTable('customer_sublogin'),
'website',
'VARCHAR(255)');
$_c01e0f340e72e992c45b537190fff109ade927d9->getConnection()->addColumn($_c01e0f340e72e992c45b537190fff109ade927d9->getTable('customer_sublogin'),
'company',
'VARCHAR(255)');
$_c01e0f340e72e992c45b537190fff109ade927d9->addAttribute('customer',
'kcp',
array(
'type'
=>
'varchar',
'input'
=>
'text',
'label'
=>
'KCP',
'visible'
=>
true,
'required'
=>
false,
'user_defined'
=>
true,
));
$_c01e0f340e72e992c45b537190fff109ade927d9->addAttribute('customer',
'klt',
array(
'type'
=>
'varchar',
'input'
=>
'text',
'label'
=>
'KLT',
'visible'
=>
true,
'required'
=>
false,
'user_defined'
=>
true,
));
$_c01e0f340e72e992c45b537190fff109ade927d9->addAttribute('customer',
'website',
array(
'type'
=>
'varchar',
'input'
=>
'text',
'label'
=>
'Website',
'visible'
=>
true,
'required'
=>
false,
'user_defined'
=>
true,
));
$_c01e0f340e72e992c45b537190fff109ade927d9->addAttribute('customer',
'company',
array(
'type'
=>
'varchar',
'input'
=>
'text',
'label'
=>
'Company',
'visible'
=>
true,
'required'
=>
false,
'user_defined'
=>
true,
));
$_c01e0f340e72e992c45b537190fff109ade927d9->endSetup();
Mage::getSingleton('eav/config')
->getAttribute('customer',
'kcp')
->setData('used_in_forms',
array('adminhtml_customer'))
->save();
Mage::getSingleton('eav/config')
->getAttribute('customer',
'klt')
->setData('used_in_forms',
array('adminhtml_customer'))
->save();
Mage::getSingleton('eav/config')
->getAttribute('customer',
'website')
->setData('used_in_forms',
array('adminhtml_customer'))
->save();
Mage::getSingleton('eav/config')
->getAttribute('customer',
'company')
->setData('used_in_forms',
array('adminhtml_customer'))
->save();
Mage::getSingleton('adminhtml/session')->addSuccess('Successfully installed project no. 238 customization');
$this->_redirect('adminhtml/dashboard');
}
public
function
gridAction()
{
$_ce376578098cf70af7021fca72fe4e15a4a98365
=
$this->getRequest()->getParam('id');
Mage::register('current_customer',
Mage::getModel('customer/customer')->load($_ce376578098cf70af7021fca72fe4e15a4a98365));
echo
Mage::getSingleton('core/layout')->createBlock('sublogin/customer_edit_tab_sublogin_grid')->toHtml();
}
public
function
newAction()
{
$_ce376578098cf70af7021fca72fe4e15a4a98365
=
$this->getRequest()->getParam('cid');
Mage::register('current_customer',
Mage::getModel('customer/customer')->load($_ce376578098cf70af7021fca72fe4e15a4a98365));
$_384d479d3c396afbfb7e832d2d450608e3145d55
=
Mage::getModel('sublogin/sublogin');
$_384d479d3c396afbfb7e832d2d450608e3145d55->setEntityId(Mage::registry('current_customer')->getId());
$this->editAction($_384d479d3c396afbfb7e832d2d450608e3145d55);
}
public
function
editAction($_384d479d3c396afbfb7e832d2d450608e3145d55=null)
{
if
(!$_384d479d3c396afbfb7e832d2d450608e3145d55)
{
$_ce376578098cf70af7021fca72fe4e15a4a98365
=
$this->getRequest()->getParam('id');
$_384d479d3c396afbfb7e832d2d450608e3145d55
=
Mage::getModel('sublogin/sublogin')->load($_ce376578098cf70af7021fca72fe4e15a4a98365);
if
(!$_384d479d3c396afbfb7e832d2d450608e3145d55->getId())
{
Mage::getSingleton('adminhtml/session')->addError(Mage::helper('sublogin')->__('Item does not exist'));
$this->renderClosewindow();
return;
}
$_ce376578098cf70af7021fca72fe4e15a4a98365
=
$this->getRequest()->getParam('cid');
if
(!$_ce376578098cf70af7021fca72fe4e15a4a98365)
$_ce376578098cf70af7021fca72fe4e15a4a98365
=
$_384d479d3c396afbfb7e832d2d450608e3145d55->getEntityId();
Mage::register('current_customer',
Mage::getModel('customer/customer')->load($_ce376578098cf70af7021fca72fe4e15a4a98365));
}
Mage::register('subloginModel',
$_384d479d3c396afbfb7e832d2d450608e3145d55);
$this->loadLayout();
$this->getLayout()->getBlock('head')->setCanLoadExtJs(true);
$this->_addContent($this->getLayout()->createBlock('sublogin/customer_edit_tab_sublogin_edit'));
$this->renderLayout();
}
public
function
saveAction()
{
if
(!$this->getRequest()->getPost())
{
$this->_redirect('*/*/');
}
$_ce376578098cf70af7021fca72fe4e15a4a98365
=
(int)$this->getRequest()->getParam('id');
$_384d479d3c396afbfb7e832d2d450608e3145d55
=
Mage::getModel('sublogin/sublogin')->load($_ce376578098cf70af7021fca72fe4e15a4a98365);
$_7e7eef674650ac545be8b71d34aed41774cfbe08
=
$this->getRequest()->getPost();
$_7e7eef674650ac545be8b71d34aed41774cfbe08
=
$this->setMissingParams($_7e7eef674650ac545be8b71d34aed41774cfbe08);
if
(isset($_7e7eef674650ac545be8b71d34aed41774cfbe08['address_ids'])
&&
is_array($_7e7eef674650ac545be8b71d34aed41774cfbe08['address_ids']))
{
$_7e7eef674650ac545be8b71d34aed41774cfbe08['address_ids']
=
implode(',',$_7e7eef674650ac545be8b71d34aed41774cfbe08['address_ids']);
}
if
(isset($_7e7eef674650ac545be8b71d34aed41774cfbe08['acl'])
&&
is_array($_7e7eef674650ac545be8b71d34aed41774cfbe08['acl']))
{
$_7e7eef674650ac545be8b71d34aed41774cfbe08['acl']
=
implode(',',$_7e7eef674650ac545be8b71d34aed41774cfbe08['acl']);
}
$_506da6907f960f50cad09ca45512519f91515237
=
trim($_7e7eef674650ac545be8b71d34aed41774cfbe08['password']);
if
(empty($_506da6907f960f50cad09ca45512519f91515237)
||
$_506da6907f960f50cad09ca45512519f91515237
==
"******")
{
unset($_7e7eef674650ac545be8b71d34aed41774cfbe08['password']);
}
else
{
if
($_384d479d3c396afbfb7e832d2d450608e3145d55->getId())
{
$_7e7eef674650ac545be8b71d34aed41774cfbe08['password']
=
Mage::helper('core')->getHash($_506da6907f960f50cad09ca45512519f91515237,
2);

$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('password',
$_506da6907f960f50cad09ca45512519f91515237);
Mage::helper('sublogin/email')->sendNewPasswordEmail($_384d479d3c396afbfb7e832d2d450608e3145d55);
}
}
if
(empty($_7e7eef674650ac545be8b71d34aed41774cfbe08['expire_date']))
{
$_7e7eef674650ac545be8b71d34aed41774cfbe08['expire_date']
=
'0000-00-00';
}
if
(!isset($_7e7eef674650ac545be8b71d34aed41774cfbe08['send_backendmails']))
{
$_7e7eef674650ac545be8b71d34aed41774cfbe08['send_backendmails']
=
false;
}
if
(!isset($_7e7eef674650ac545be8b71d34aed41774cfbe08['create_sublogins']))
{
$_7e7eef674650ac545be8b71d34aed41774cfbe08['create_sublogins']
=
false;
}
if
(!isset($_7e7eef674650ac545be8b71d34aed41774cfbe08['active']))
{
$_7e7eef674650ac545be8b71d34aed41774cfbe08['active']
=
false;
}
if
(!isset($_7e7eef674650ac545be8b71d34aed41774cfbe08['order_needs_approval']))
{
$_7e7eef674650ac545be8b71d34aed41774cfbe08['order_needs_approval']
=
false;
}
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData($_7e7eef674650ac545be8b71d34aed41774cfbe08);
$_02000d93f53443c66f188e6620797faaaeba5739
=
false;
if
(!$_384d479d3c396afbfb7e832d2d450608e3145d55->getId()
&&
$_384d479d3c396afbfb7e832d2d450608e3145d55->getData('send_backendmails'))
{
$_02000d93f53443c66f188e6620797faaaeba5739
=
true;
}
$_384d479d3c396afbfb7e832d2d450608e3145d55->save();

if
($_02000d93f53443c66f188e6620797faaaeba5739)
{
$_384d479d3c396afbfb7e832d2d450608e3145d55->setData('password',
$_506da6907f960f50cad09ca45512519f91515237);
Mage::helper('sublogin/email')->sendNewSubloginEmail($_384d479d3c396afbfb7e832d2d450608e3145d55);
}
Mage::getSingleton('adminhtml/session')->addSuccess(Mage::helper('adminhtml')->__('Item was successfully saved'));
if
($this->getRequest()->getParam('back'))
{
$this->_redirect('*/*/edit',
array('id'=>$_384d479d3c396afbfb7e832d2d450608e3145d55->getId(),
'cid'=>$_384d479d3c396afbfb7e832d2d450608e3145d55->getEntityId()));
return;
}
$this->renderClosewindow();
}
public
function
gridMassDeleteAction()
{
$_8ebc20c2a00ee934fb32564781e5f3b40d3bf7af
=
$this->getRequest()->getParam('sublogins');
if
(!is_array($_8ebc20c2a00ee934fb32564781e5f3b40d3bf7af))
{
Mage::getSingleton('adminhtml/session')->addError(Mage::helper('sublogin')->__('Please select Sublogins.'));
}
else
{
foreach
($_8ebc20c2a00ee934fb32564781e5f3b40d3bf7af
as
$_ce376578098cf70af7021fca72fe4e15a4a98365)
{
$_384d479d3c396afbfb7e832d2d450608e3145d55
=
Mage::getModel('sublogin/sublogin')->load($_ce376578098cf70af7021fca72fe4e15a4a98365);
if
($_384d479d3c396afbfb7e832d2d450608e3145d55->getId())
$_384d479d3c396afbfb7e832d2d450608e3145d55->delete();
}
Mage::getSingleton('adminhtml/session')->addSuccess(Mage::helper('sublogin')->__('Deletion successful'));
}
$_ce376578098cf70af7021fca72fe4e15a4a98365
=
$this->getRequest()->getParam('id');
$this->_redirect('customer/entity/edit',
array('id'=>$_ce376578098cf70af7021fca72fe4e15a4a98365));
}
public
function
deleteAction()
{
$_ce376578098cf70af7021fca72fe4e15a4a98365
=
$this->getRequest()->getParam('id');
$_384d479d3c396afbfb7e832d2d450608e3145d55
=
Mage::getModel('sublogin/sublogin')->load($_ce376578098cf70af7021fca72fe4e15a4a98365);
$_384d479d3c396afbfb7e832d2d450608e3145d55->delete();
Mage::getSingleton('adminhtml/session')->addSuccess(Mage::helper('adminhtml')->__('Item was successfully deleted'));
$this->_redirect('sublogin/adminhtml_index/');
}

public
function
deleteSingleSubloginAction()
{
$_ce376578098cf70af7021fca72fe4e15a4a98365
=
$this->getRequest()->getParam('id');
$_384d479d3c396afbfb7e832d2d450608e3145d55
=
Mage::getModel('sublogin/sublogin')->load($_ce376578098cf70af7021fca72fe4e15a4a98365);
$_384d479d3c396afbfb7e832d2d450608e3145d55->delete();
Mage::getSingleton('adminhtml/session')->addSuccess(Mage::helper('adminhtml')->__('Item was successfully deleted'));
$this->_redirect('sublogin/adminhtml_index/');
}
protected
function
renderClosewindow()
{
$this->_getSession()->addNotice(
Mage::helper('sublogin')->__('Please click on the Close Window button if it is not closed automatically.')
);
$this->loadLayout('popup');
$this->_addContent(
$this->getLayout()->createBlock('sublogin/closebutton')
);
$this->renderLayout();
}
public
function
customerinfoAction()
{
$_00bfc7a78eb28c3a15ee3f0a828d5a0f3f8d9b1d
=
$this->getRequest()->getParam('customer_id');
$_56a88c9d4d6dd48bae8e9515fb7a25734f539b06
=
array();
if
($_00bfc7a78eb28c3a15ee3f0a828d5a0f3f8d9b1d)
{
$_b803c43bc8b3ef64b7d19b78f670cdbd11dacf8c
=
Mage::getModel('customer/customer')->load($_00bfc7a78eb28c3a15ee3f0a828d5a0f3f8d9b1d);
if
($_b803c43bc8b3ef64b7d19b78f670cdbd11dacf8c->getId())
{
$_91a2a43f77d1dc504cd0664864c1dfd4834a8f53
=
Mage::getModel('core/website')->load($_b803c43bc8b3ef64b7d19b78f670cdbd11dacf8c->getWebsiteId());
$_6ab22cf5b83adf50f6320e3b010f11ee77b3b669
=
array();
foreach
($_91a2a43f77d1dc504cd0664864c1dfd4834a8f53->getStoreCollection()
as
$_7ff01efcb6976550e400d525bb2f8f2090febc06)
{
$_6ab22cf5b83adf50f6320e3b010f11ee77b3b669[]
=
"<option value='".$_7ff01efcb6976550e400d525bb2f8f2090febc06->getId()."'>".$_7ff01efcb6976550e400d525bb2f8f2090febc06->getCode()."</option>";
}
$_56a88c9d4d6dd48bae8e9515fb7a25734f539b06['storeOptions']
=
implode("",
$_6ab22cf5b83adf50f6320e3b010f11ee77b3b669);
$_81e77768f3068185edd8fda5ab1f65a052f81082
=
array();
foreach
($_b803c43bc8b3ef64b7d19b78f670cdbd11dacf8c->getAddresses()
as
$_17d2af4b1493648e1cc1cb8dffce9a7658374484)
{
$_e654d1a18146651e3bfe6fd079c03211dddd7e9f
=
'';
$_1b144addba58891e49d3fed7e7095afd8ce1c0e5
=
$_17d2af4b1493648e1cc1cb8dffce9a7658374484->getStreet();
foreach
($_1b144addba58891e49d3fed7e7095afd8ce1c0e5
as
$_317d4a7f0913fca2b26a7e355e8f6ae219b839ca)
{
$_e654d1a18146651e3bfe6fd079c03211dddd7e9f
.=
isset($_317d4a7f0913fca2b26a7e355e8f6ae219b839ca)
?
$_317d4a7f0913fca2b26a7e355e8f6ae219b839ca
:
'';
$_e654d1a18146651e3bfe6fd079c03211dddd7e9f
.=
' ';
}
$_e60edee9bbcec9af2084c09a7e3e3bf5a0643e9f
=
$_17d2af4b1493648e1cc1cb8dffce9a7658374484->getCompany()
.
' '
.
$_e654d1a18146651e3bfe6fd079c03211dddd7e9f
.
' '
.
$_17d2af4b1493648e1cc1cb8dffce9a7658374484->getPostcode()
.
' '
.
$_17d2af4b1493648e1cc1cb8dffce9a7658374484->getCity();

$_81e77768f3068185edd8fda5ab1f65a052f81082[]
=
"<option value='".$_17d2af4b1493648e1cc1cb8dffce9a7658374484->getId()."'>".$_e60edee9bbcec9af2084c09a7e3e3bf5a0643e9f."</option>";
}
$_56a88c9d4d6dd48bae8e9515fb7a25734f539b06['customerAddresses']
=
implode("",
$_81e77768f3068185edd8fda5ab1f65a052f81082);
}
}
$this->getResponse()->setBody(Mage::helper('core')->jsonEncode($_56a88c9d4d6dd48bae8e9515fb7a25734f539b06));
}

protected
function
setMissingParams($_7e7eef674650ac545be8b71d34aed41774cfbe08)
{
$_3c464bebc1012e6fd8265f7c6ee6ea7e5be9a6b1
=
Mage::getModel('sublogin/source_formfields')->getDefaultValues();
foreach
($_3c464bebc1012e6fd8265f7c6ee6ea7e5be9a6b1
as
$_3f8de01169eabbb582c7c5ffb762d5f7d1f1bf07
=>
$_f0c614d70c91a56750ab0372fc6e1ac48138cd31)
{
if
(!isset($_7e7eef674650ac545be8b71d34aed41774cfbe08[$_3f8de01169eabbb582c7c5ffb762d5f7d1f1bf07]))
{
$_7e7eef674650ac545be8b71d34aed41774cfbe08[$_3f8de01169eabbb582c7c5ffb762d5f7d1f1bf07]
=
$_f0c614d70c91a56750ab0372fc6e1ac48138cd31;
}
}
return
$_7e7eef674650ac545be8b71d34aed41774cfbe08;
}
}