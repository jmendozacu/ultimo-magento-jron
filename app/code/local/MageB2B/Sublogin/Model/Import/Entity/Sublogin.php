<?php

class
MageB2B_Sublogin_Model_Import_Entity_Sublogin
extends
Mage_ImportExport_Model_Import_Entity_Abstract
{
const
COL_ENTITY_ID
=
"entity_id";
const
COL_EMAIL
=
"email";
const
COL_FIRSTNAME
=
"firstname";
const
COL_LASTNAME
=
"lastname";
const
COL_STORE_ID
=
"store_id";
const
MAX_PASSWD_LENGTH
=
6;

const
DEFAULT_EXPIRY_DAYS
=
90;

const
ERROR_INVALID_WEBSITE
=
'invalidWebsite';
const
ERROR_INVALID_EMAIL
=
'invalidEmail';
const
ERROR_DUPLICATE_EMAIL_SITE
=
'duplicateEmailSite';
const
ERROR_EMAIL_IS_EMPTY
=
'emailIsEmpty';
const
ERROR_ROW_IS_ORPHAN
=
'rowIsOrphan';
const
ERROR_VALUE_IS_REQUIRED
=
'valueIsRequired';
const
ERROR_INVALID_STORE
=
'invalidStore';
const
ERROR_EMAIL_SITE_NOT_FOUND
=
'emailSiteNotFound';
const
ERROR_PASSWORD_LENGTH
=
'passwordLength';
const
ERROR_INVALID_ENTITY_ID
=
'invalidEntityId';
protected
$_entityTable;
protected
$_oldSublogins;
protected
$_newSublogins;
protected
$_storeCodeToId;
protected
$_allCustomerIds;

protected
$_messageTemplates
=
array(
self::ERROR_INVALID_ENTITY_ID
=>
'Invalid value in entity_id column (customer does not exists?)',
self::ERROR_INVALID_WEBSITE
=>
'Invalid value in Website column (website does not exists?)',
self::ERROR_INVALID_EMAIL
=>
'E-mail is invalid',
self::ERROR_DUPLICATE_EMAIL_SITE
=>
'E-mail is duplicated in import file',
self::ERROR_EMAIL_IS_EMPTY
=>
'E-mail is not specified',
self::ERROR_ROW_IS_ORPHAN
=>
'Orphan rows that will be skipped due default row errors',
self::ERROR_VALUE_IS_REQUIRED
=>
"Required attribute '%s' has an empty value",
self::ERROR_INVALID_STORE
=>
'Invalid value in Store column (store does not exists?)',
self::ERROR_EMAIL_SITE_NOT_FOUND
=>
'E-mail and website combination is not found',
self::ERROR_PASSWORD_LENGTH
=>
'Invalid password length'
);

protected
$_permanentAttributes
=
array(self::COL_ENTITY_ID,
self::COL_EMAIL,
self::COL_FIRSTNAME,
self::COL_LASTNAME);

public
function
__construct()
{
parent::__construct();
$this->_initStores()
->_initCustomers()
->_initSublogins()
;
$this->_entityTable
=
Mage::getModel('customer/customer')->getResource()->getTable('sublogin/sublogin');
}
protected
function
_initCustomers()
{
$this->_allCustomerIds
=
Mage::getModel('customer/customer')->getCollection()->getAllIds();
return
$this;
}

protected
function
_initStores()
{
foreach
(Mage::app()->getStores(true)
as
$_7ff01efcb6976550e400d525bb2f8f2090febc06)
{
$this->_storeCodeToId[$_7ff01efcb6976550e400d525bb2f8f2090febc06->getCode()]
=
$_7ff01efcb6976550e400d525bb2f8f2090febc06->getId();
}
return
$this;
}
protected
function
_initSublogins()
{
foreach
(Mage::getModel('sublogin/sublogin')->getCollection()
as
$_4e45fa4f3249d9c3cc1314ed89922593008cf117)
{
$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607
=
$_4e45fa4f3249d9c3cc1314ed89922593008cf117->getEmail();
$_d19f29254a19bec723c54975fdca138389407a19
=
$_4e45fa4f3249d9c3cc1314ed89922593008cf117->getEntityId();

$_e79f42cd6fb01fb1483aa880b524a8d65c7b6081
=
$_4e45fa4f3249d9c3cc1314ed89922593008cf117->getStoreId();
if
(!isset($this->_oldSublogins[$_e79f42cd6fb01fb1483aa880b524a8d65c7b6081][$_d19f29254a19bec723c54975fdca138389407a19][$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607]))
{
$this->_oldSublogins[$_e79f42cd6fb01fb1483aa880b524a8d65c7b6081][$_d19f29254a19bec723c54975fdca138389407a19][$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607]
=
array();
}
$this->_oldSublogins[$_e79f42cd6fb01fb1483aa880b524a8d65c7b6081][$_d19f29254a19bec723c54975fdca138389407a19][$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607]
=
$_4e45fa4f3249d9c3cc1314ed89922593008cf117->getId();
}
return
$this;
}

public
function
getEntityTypeCode()
{
return
'sublogin';
}

public
function
validateRow(array
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9,
$_aff33f624f1937ce04460117b27455912e1855af)
{


if
(isset($this->_validatedRows[$_aff33f624f1937ce04460117b27455912e1855af]))
{

return
!isset($this->_invalidRows[$_aff33f624f1937ce04460117b27455912e1855af]);
}
$this->_validatedRows[$_aff33f624f1937ce04460117b27455912e1855af]
=
true;
$this->_processedEntitiesCount
++;
$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607
=
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_EMAIL];
$_2899572bbfe45ff9c6681ad22fd211aa42c9b569
=
strtolower($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_EMAIL]);
$_d19f29254a19bec723c54975fdca138389407a19
=
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_ENTITY_ID];
$_e79f42cd6fb01fb1483aa880b524a8d65c7b6081
=
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_STORE_ID];
$_23e4e5c6f6a86c11c52dcedab299b01a2b2f2f1b
=
array_change_key_case($this->_oldSublogins,
CASE_LOWER);
$_68c295590bf500ced7774f7b7452693908acf910
=
array_change_key_case($this->_newSublogins,
CASE_LOWER);

if
(Mage_ImportExport_Model_Import::BEHAVIOR_DELETE
==
$this->getBehavior())
{
if(!isset($_23e4e5c6f6a86c11c52dcedab299b01a2b2f2f1b[$_e79f42cd6fb01fb1483aa880b524a8d65c7b6081][$_d19f29254a19bec723c54975fdca138389407a19][$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607])){
$this->addRowError(self::ERROR_EMAIL_SITE_NOT_FOUND,
$_aff33f624f1937ce04460117b27455912e1855af);
}
}
else
{
if
(!Zend_Validate::is($_ff0a3525eb1a63ce44e7951a0b522829a4d2f607,
'EmailAddress'))
{
$this->addRowError(self::ERROR_INVALID_EMAIL,
$_aff33f624f1937ce04460117b27455912e1855af);
}
else
{
if
(isset($_68c295590bf500ced7774f7b7452693908acf910[$_e79f42cd6fb01fb1483aa880b524a8d65c7b6081][$_d19f29254a19bec723c54975fdca138389407a19][$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607]))
{
$this->addRowError(self::ERROR_DUPLICATE_EMAIL_SITE,
$_aff33f624f1937ce04460117b27455912e1855af);
}
$this->_newSublogins[$_e79f42cd6fb01fb1483aa880b524a8d65c7b6081][$_d19f29254a19bec723c54975fdca138389407a19][$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607]
=
false;
if(!empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_STORE_ID])
&&
!is_numeric($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_STORE_ID])
&&
!isset($this->_storeCodeToId[$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_STORE_ID]])
){
$this->addRowError(self::ERROR_INVALID_STORE,
$_aff33f624f1937ce04460117b27455912e1855af);
}elseif(
is_numeric($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_STORE_ID])
&&
!@in_array($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_STORE_ID],
$this->_storeCodeToId)){
$this->addRowError(self::ERROR_INVALID_STORE,
$_aff33f624f1937ce04460117b27455912e1855af);
}

if(!@in_array($_d19f29254a19bec723c54975fdca138389407a19,
$this->_allCustomerIds)){

$this->addRowError(self::ERROR_INVALID_ENTITY_ID,
$_aff33f624f1937ce04460117b27455912e1855af);
}

if
(isset($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['password'])
&&
strlen($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['password'])
&&
Mage::helper('core/string')->strlen($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['password'])
<
self::MAX_PASSWD_LENGTH
)
{
$this->addRowError(self::ERROR_PASSWORD_LENGTH,
$_aff33f624f1937ce04460117b27455912e1855af);
}
}
}
return
!isset($this->_invalidRows[$_aff33f624f1937ce04460117b27455912e1855af]);
}

protected
function
_importData()
{
if
(Mage_ImportExport_Model_Import::BEHAVIOR_DELETE
==
$this->getBehavior())
{
$this->_deleteSublogins();
}
else
{
$this->_saveSublogins();
}
return
true;
}
protected
function
_deleteSublogins()
{
while
($_fc619f04005aa176dc83b766703e47a1fe3766df
=
$this->_dataSourceModel->getNextBunch())
{
$_2b41c436c3858e16c47680051025cb692f9af90c
=
array();
foreach
($_fc619f04005aa176dc83b766703e47a1fe3766df
as
$_aff33f624f1937ce04460117b27455912e1855af
=>
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9)
{
if
($this->validateRow($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9,
$_aff33f624f1937ce04460117b27455912e1855af))
{
$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607
=
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_EMAIL];
$_2899572bbfe45ff9c6681ad22fd211aa42c9b569
=
strtolower($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_EMAIL]);
$_d19f29254a19bec723c54975fdca138389407a19
=
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_ENTITY_ID];
$_e79f42cd6fb01fb1483aa880b524a8d65c7b6081
=
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_STORE_ID];
$_2b41c436c3858e16c47680051025cb692f9af90c[]
=
$this->_oldSublogins[$_e79f42cd6fb01fb1483aa880b524a8d65c7b6081][$_d19f29254a19bec723c54975fdca138389407a19][$_2899572bbfe45ff9c6681ad22fd211aa42c9b569];
}
}
if
($_2b41c436c3858e16c47680051025cb692f9af90c)
{
$this->_connection->query(
$this->_connection->quoteInto(
"DELETE FROM `{$this->_entityTable}` WHERE `id` IN (?)",
$_2b41c436c3858e16c47680051025cb692f9af90c
)
);
}
}
return
$this;
}

protected
function
_saveSublogins()
{
$_7db6df59a882fa9b6c2a6e49a36b0f579969198b
=
Mage::getModel('sublogin/sublogin');
$_72d6e7b8a81bce45d9a6a08c264a4a8c7fba3b67
=
Varien_Date::convertZendToStrftime(Varien_Date::DATETIME_INTERNAL_FORMAT,
true,
true);
$_619f2f7036ba5fbdda57b17825965ca9dcf53f2d
=
$_7db6df59a882fa9b6c2a6e49a36b0f579969198b->getResource()->getTable('sublogin/sublogin');

$_826ac81b600de90edf50807750cadbf5e3472cd0
=
Mage::getResourceHelper('importexport')->getNextAutoincrement($_619f2f7036ba5fbdda57b17825965ca9dcf53f2d);
while
($_fc619f04005aa176dc83b766703e47a1fe3766df
=
$this->_dataSourceModel->getNextBunch())
{
$_ec3c8c69350539b4b891cdadf9ca1402bb079b2b
=
array();
$_3dd5bfd6452e735ee202bd6a62310c3a943a942d
=
array();
$_23e4e5c6f6a86c11c52dcedab299b01a2b2f2f1b
=
array_change_key_case($this->_oldSublogins,
CASE_LOWER);
foreach
($_fc619f04005aa176dc83b766703e47a1fe3766df
as
$_aff33f624f1937ce04460117b27455912e1855af
=>
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9)
{
if
(!$this->validateRow($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9,
$_aff33f624f1937ce04460117b27455912e1855af))
{
continue;
}
$_c6044a04428a38b473f1cf8ee777cafff97f3b0c
=
gmstrftime($_72d6e7b8a81bce45d9a6a08c264a4a8c7fba3b67,
strtotime("+ ".self::DEFAULT_EXPIRY_DAYS." days"));
$_d19f29254a19bec723c54975fdca138389407a19
=
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_ENTITY_ID])
?
0
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_ENTITY_ID];
$_e79f42cd6fb01fb1483aa880b524a8d65c7b6081
=
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_STORE_ID])
?
0
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_STORE_ID];
$_ff0a3525eb1a63ce44e7951a0b522829a4d2f607
=
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_EMAIL])
?
''
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_EMAIL];
$_2899572bbfe45ff9c6681ad22fd211aa42c9b569
=
strtolower($_ff0a3525eb1a63ce44e7951a0b522829a4d2f607);

$_48b69966511a1516081c24326c362b7099172474
=
array(
'entity_id'
=>
$_d19f29254a19bec723c54975fdca138389407a19,
'customer_id'
=>
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['customer_id'])
?
''
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['customer_id'],
'email'
=>
$_2899572bbfe45ff9c6681ad22fd211aa42c9b569,
'password'
=>
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['password'])
?
Mage::helper('core')->getHash('123456',
2)
:
Mage::helper('core')->getHash($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['password'],
2),
'rp_token'
=>
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['rp_token'])
?
0
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['rp_token'],
'rp_token_created_at'
=>
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['rp_token_created_at'])
?
0
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['rp_token_created_at'],
'firstname'
=>
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_FIRSTNAME])
?
'firstname'
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_FIRSTNAME],
'lastname'
=>
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_LASTNAME])
?
'lastname'
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9[self::COL_LASTNAME],
'expire_date'
=>
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['expire_date'])
?
$_c6044a04428a38b473f1cf8ee777cafff97f3b0c
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['expire_date'],
'active'
=>
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['active'])
?
0
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['active'],
'send_backendmails'
=>
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['send_backendmails'])
?
1
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['send_backendmails'],
'store_id'
=>
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['store_id'])
?
0
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['store_id'],
'address_ids'
=>
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['address_ids'])
?
''
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['address_ids'],
'create_sublogins'
=>
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['create_sublogins'])
?
0
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['create_sublogins'],
'is_subscribed'
=>
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['is_subscribed'])
?
0
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['is_subscribed'],
'prefix'
=>
empty($_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['prefix'])
?
''
:
$_e02fbefe8dd8ff9651f964f9f9798a32fdaf63a9['prefix'],
);
if
(isset($_23e4e5c6f6a86c11c52dcedab299b01a2b2f2f1b[$_e79f42cd6fb01fb1483aa880b524a8d65c7b6081][$_d19f29254a19bec723c54975fdca138389407a19][$_2899572bbfe45ff9c6681ad22fd211aa42c9b569]))
{

$_48b69966511a1516081c24326c362b7099172474['id']
=
$_23e4e5c6f6a86c11c52dcedab299b01a2b2f2f1b[$_e79f42cd6fb01fb1483aa880b524a8d65c7b6081][$_d19f29254a19bec723c54975fdca138389407a19][$_2899572bbfe45ff9c6681ad22fd211aa42c9b569];
$_3dd5bfd6452e735ee202bd6a62310c3a943a942d[]
=
$_48b69966511a1516081c24326c362b7099172474;
}
else
{
$_76e2873fa893a2a0fb1fdf179ed951f32e603054
=
$_826ac81b600de90edf50807750cadbf5e3472cd0++;
$_48b69966511a1516081c24326c362b7099172474['id']
=
$_76e2873fa893a2a0fb1fdf179ed951f32e603054;
$_ec3c8c69350539b4b891cdadf9ca1402bb079b2b[]
=
$_48b69966511a1516081c24326c362b7099172474;
$this->_newSublogins[$_e79f42cd6fb01fb1483aa880b524a8d65c7b6081][$_d19f29254a19bec723c54975fdca138389407a19][$_2899572bbfe45ff9c6681ad22fd211aa42c9b569]
=
$_76e2873fa893a2a0fb1fdf179ed951f32e603054;
}
}
$this->_saveSubloginEntity($_ec3c8c69350539b4b891cdadf9ca1402bb079b2b,
$_3dd5bfd6452e735ee202bd6a62310c3a943a942d);
}
return
$this;
}

protected
function
_saveSubloginEntity($_ec3c8c69350539b4b891cdadf9ca1402bb079b2b,
$_3dd5bfd6452e735ee202bd6a62310c3a943a942d)
{
if
($_ec3c8c69350539b4b891cdadf9ca1402bb079b2b)
{
$this->_connection->insertMultiple($this->_entityTable,
$_ec3c8c69350539b4b891cdadf9ca1402bb079b2b);
}
if
($_3dd5bfd6452e735ee202bd6a62310c3a943a942d)
{
$this->_connection->insertOnDuplicate(
$this->_entityTable,
$_3dd5bfd6452e735ee202bd6a62310c3a943a942d
);
}
return
$this;
}
}